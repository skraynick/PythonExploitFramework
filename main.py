import time

import click
import shodan
import pyfiglet
import tkinter as tk
from tkinter import ttk, Text, Label, Toplevel, Button, Entry, Menu

from tkinter.messagebox import showinfo
from functools import partial
from tkinter.scrolledtext import ScrolledText


class Main:
    root = tk.Tk()
    frame = tk.Frame(root)

    api_key = tk.StringVar()
    shodan_query = tk.StringVar()
    shodan_query_page = tk.StringVar()
    t = Text(root, height=1)
    instances = ""


def get_shodan_api_key():
    top = Toplevel(Main.root)
    top.geometry("250x250")
    top.title("Enter your API key!")
    api_label = Label(top, text="Shodan Api Key:")
    api_label.pack()

    api_key_entry = ttk.Entry(top, textvariable=Main.api_key)
    api_key_entry.pack()
    api_key_entry.focus()
    save_button = ttk.Button(top, text="Save", command=partial(save_api_key, top))
    save_button.pack()


def save_api_key(top):
    if len(Main.api_key.get()) > 0:
        msg = f'Your api key: {Main.api_key.get()}'
        showinfo(
            title='Information',
            message=msg
        )
        top.destroy()
        Main.t.insert(tk.END, msg)


def set_layout_search():
    Label(Main.root, text="Shodan Search term (1st box) and pages (2nd box).").pack(side="left")
    Entry(Main.root, textvariable=Main.shodan_query).pack(side="left")
    Entry(Main.root, textvariable=Main.shodan_query_page).pack(side="left")
    Button(Main.root, text="Search", command=request_page_from_shodan()).pack(side="left")


def request_page_from_shodan():
    while True:
        try:
            # Main.instances = Main.api_key.get().search(Main.shodan_query, page=Main.shodan_query_page)
            return Main.instances
        except shodan.APIError as error:
            print(f'Error: {error}')
            time.sleep(5)


def add_menu():
    menubar = Menu(Main.root)
    file = Menu(menubar)
    menubar.add_cascade(label="File", menu=file)
    file.add_command(label='New File', command=None)
    file.add_command(label='Open...', command=None)
    file.add_command(label='Save', command=None)
    file.add_separator()
    file.add_command(label='Exit', command=Main.root.destroy)

    # Settings menu items.
    settings = Menu(menubar)
    menubar.add_cascade(label='Settings', menu=settings)
    settings.add_command(label='Shodan API')
    settings.add_separator()

    # Help Menu items
    help = Menu(menubar)
    menubar.add_cascade(label='Help', menu=help)
    help.add_command(label='Tk Help', command=None)
    help.add_command(label='Demo', command=None)
    help.add_separator()
    help.add_command(label='About Tk', command=None)

    Main.root.config(menu=menubar)


def main():
    Main.root.title('My Tool')
    add_menu()
    Label(Main.root, text=" Click the Below Button to enter your Shodan API Key.", font='Helvetica 14 bold').pack()
    Button(Main.root, text="Enter API key!", command=get_shodan_api_key).pack()

    Main.t.pack()
    # result = pyfiglet.figlet_format("Python Exploit")
    # print(result)
    # set_layout_search()
    # st = ScrolledText(Main.root, width=50, height=10)
    # st.pack(side="bottom")

    Main.root.geometry('800x400+50+50')
    Main.root.mainloop()


if __name__ == '__main__':
    main()
